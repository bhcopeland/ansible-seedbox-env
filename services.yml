---

- name: ensure cron exists
  template:
    src: cron.j2
    dest: "/var/spool/cron/crontabs/{{username}}"  
    owner: "{{username}}"

- name: update default shell
  user: 
    name: "{{username}}"
    shell: /bin/zsh

- name: Ensure paths exist
  file:
    path: "{{item}}"
    owner: "{{username}}"
    state: directory
  with_items:
    - "{{flexget_path}}"
    - /media/Storage/
    - "{{mnt_dir}}/torrents/rtorrent/completed"
    - "{{mnt_dir}}/torrents/rtorrent/TV"
    - "{{mnt_dir}}/torrents/rtorrent/Movies"
    - "{{mnt_dir}}/torrents/rtorrent/Music"
    - "{{mnt_dir}}/torrents/rtorrent/Seed"
    - "{{mnt_dir}}/TV"
    - "{{mnt_dir}}/completed/TV"
    - "{{mnt_dir}}/TV_4K"
    - "{{mnt_dir}}/completed/TV_4K"
    - "{{mnt_dir}}/Movies_4K"
    - "{{mnt_dir}}/completed/Movies_4K"
    - "{{mnt_dir}}/Movies"
    - "{{mnt_dir}}/completed/Movies"
    - "{{data_dir}}/TV"
    - "{{data_dir}}/TV_4K"
    - "{{data_dir}}/Movies_4K"
    - "{{data_dir}}/Movies"
    - "{{data_dir}}/completed/Movies"

- name: Copy flexget config
  copy:
    src: "{{playbook_dir}}/files/flexget"
    dest: "/opt"
    owner: "{{username}}"
    force: yes
    directory_mode: yes

- name: Install flexget
  pip:
    name: flexget
    virtualenv: "{{flexget_path}}/venv"
    virtualenv_python: python3.5
  become_user: "{{username}}"

- name: Ensure rtorrent folders exist
  file:
    dest: "/home/{{username}}/torrents/rtorrent/{{item}}"
    src: "{{mnt_dir}}/torrents/rtorrent/{{item}}"
    owner: "{{username}}"
    group: "{{username}}"
    state: link
    force: yes
  with_items:
    - completed
    - Movies
    - Music
    - Seed
    - TV

# iplayer

- name: Copy get_iplayer config
  file:
    src: "{{playbook_dir}}/files/get_iplayer"
    dest: "/home/{{username}}/.get_iplayer"
    owner: "{{username}}"
    state: link
    force: yes

# rclone
- name: Copy systemd config
  copy:
    src: "{{playbook_dir}}/files/systemd/rclone.service"
    dest: /etc/systemd/system/rclone.service

- name: reload systemd
  systemd: daemon_reload=yes

- name: copy rclone conf
  copy: 
    src: "{{playbook_dir}}/files/rclone.conf"
    dest: "/home/{{username}}/.config/rclone/rclone.conf"
    owner: "{{username}}"
    force: yes

- name: enable rclone
  systemd:
    name: rclone
    enabled: yes
    state: started

